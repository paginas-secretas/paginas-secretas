var A=Object.defineProperty;var C=(r,t,e)=>t in r?A(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var o=(r,t,e)=>(C(r,typeof t!="symbol"?t+"":t,e),e);import{l as N,m as P}from"./scheduler.ad18e0d3.js";import"./index.83d2023c.js";import{c as b,C as K}from"./static-image.68038311.js";import{w as E}from"./paths.f09f5fa9.js";function j(r){return(r==null?void 0:r.length)!==void 0?r:Array.from(r)}class k{constructor(t){o(this,"writable");this.writable=t}emit(t){return this.writable.set(t)}}class O{constructor(t){o(this,"states");o(this,"events");o(this,"emitter");o(this,"initialState");o(this,"state");o(this,"subscribe");this.initialState=t,this.state=t,this.states=E(t),this.events=E(),this.emitter=new k(this.states),this.subscribe=this.states.subscribe}add(t){this.events.set(t)}on(t,e){this.events.subscribe(s=>{s&&e(s)&&t(s,n=>{this.state=n,this.emitter.emit(n)})})}reset(){this.state=this.initialState,this.emitter.emit(this.state)}}function S(r,t){return r.type===t}function H(r){return N(r)}function Z(r){return P(r.constructor,r)}class ${constructor(t){o(this,"window");this.window=t}store(t,e){return Promise.resolve(this.window.localStorage.setItem(t,e))}lookup(t){const e=this.window.localStorage.getItem(t);return Promise.resolve(e??void 0)}}var p=new Array,I={extras:void 0};function q(r){p.length=0,p.push(...r)}function z(r,{extras:t}=I){p.forEach(e=>e.logMessage(r,{extras:t}))}function f(r){p.forEach(t=>t.logError(r))}var Q=class{logMessage(r,t){console.info(`‚ÑπÔ∏è  (${r})`,t)}logWarning(r,t){console.warn(`‚ö†Ô∏è  (${r})`,t)}logFatal(r,t){console.trace(`üíÄ  (${r})`,t)}logError(r){console.error(`üêõ  (${r})`)}};class m{constructor(t){o(this,"value");this.value=t}}class a extends m{constructor(e,s){super(e);o(this,"isPublic");this.isPublic=s}static public(e){const s=typeof e=="string"?g(e):e;return new a(s,!0)}static private(e){const s=typeof e=="string"?g(e):e;return new a(s,!1)}toString(){const e=btoa(u(this.value));return this.isPublic?`-----BEGIN PUBLIC KEY-----
${e}
-----END PUBLIC KEY-----`:`-----BEGIN PRIVATE KEY-----
${e}
-----END PRIVATE KEY-----`}}class c extends m{constructor(t){super(t)}static private(t){const e=typeof t=="string"?g(t):t;return new c(e)}toString(){return`-----BEGIN PRIVATE KEY-----
${btoa(u(this.value))}
-----END PRIVATE KEY-----`}}function l(r){const t=new Uint8Array(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t.buffer}function u(r){return String.fromCodePoint(...new Uint8Array(r))}function g(r){const t=r.replaceAll(/(-----([A-Z ]{14,21})-----)|\n/g,""),e=atob(t);return l(e)}class v{constructor(){o(this,"keyUsages");this.keyUsages=["encrypt","decrypt"]}async encryptData(t,e,s,n){const i=await crypto.subtle.importKey(n,t.value,s,!0,["encrypt"]),y=await crypto.subtle.encrypt(s,i,l(e));return Promise.resolve(u(y))}async decryptData(t,e,s,n){const i=await crypto.subtle.importKey(n,t.value,s,!0,["decrypt"]),y=await crypto.subtle.decrypt(s,i,l(e));return Promise.resolve(u(y))}}class x extends v{constructor(e){super();o(this,"algorithm");this.algorithm=e}async generate(){crypto.subtle.digest;const e=await crypto.subtle.generateKey(this.algorithm,!0,this.keyUsages);return c.private(await crypto.subtle.exportKey("raw",e))}}class B extends v{constructor(e){super();o(this,"algorithm");this.algorithm=e}async generate(){const e=await crypto.subtle.generateKey(this.algorithm,!0,this.keyUsages);return{public:a.public(await crypto.subtle.exportKey("spki",e.publicKey)),private:a.private(await crypto.subtle.exportKey("pkcs8",e.privateKey))}}async encrypt(e,s){return super.encryptData(e,s,this.algorithm,"spki")}async decrypt(e,s){return super.decryptData(e,s,this.algorithm,"pkcs8")}async match(e){const s="valid";try{const n=await this.encrypt(e.public,s),i=await this.decrypt(e.private,n);return s===i}catch(n){return f(w(n)),!1}}}class J extends x{constructor(){super({name:"AES-GCM",length:256})}async encrypt(t,e){const s=crypto.getRandomValues(new Uint8Array(12)),n={name:"AES-GCM",iv:s};return{data:await super.encryptData(t,e,n,"raw"),iv:u(s.buffer)}}decrypt(t,e){const s={name:"AES-GCM",iv:l(e.iv)};return super.decryptData(t,e.data,s,"raw")}}class R extends B{constructor(){super({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}})}}class U{constructor(t){o(this,"storage");o(this,"maxStoredKeys");this.storage=t,this.maxStoredKeys=3}async cache(t){const e=t instanceof c?"sym":"asy-pair",s=await this.lookupAll(e);return s.length===this.maxStoredKeys&&s.shift(),s.push(this.toJSON(t)),this.storage.store(e,JSON.stringify(s))}async pair(t){const e=await this.lookupAll("asy-pair"),s=this.toJSON(t),n=e.find(i=>"public"in i&&i.public===s.key||"private"in i&&i.private===s.key);if(n)return this.fromJSON([n])[0]}async lookupAll(t){const e=await this.storage.lookup(t)??"[]";return JSON.parse(e)}fromJSON(t){return t.map(s=>{if("public"in s&&"private"in s)return{public:a.public(atob(`${s.public}`)),private:a.private(atob(`${s.private}`))};if("key"in s)return c.private(atob(`${s.key}`));throw new Error(`Invalid JSON: ${JSON.stringify(s)}`)})}toJSON(t){return t instanceof m?{key:btoa(t.toString())}:{public:btoa(t.public.toString()),private:btoa(t.private.toString())}}}class D{constructor(t){this.client=t}async add(t){try{const e={contacts:t},s=await this.client.add(b,JSON.stringify(e));return s.status==200?s.json():Promise.resolve(s.status)}catch(e){throw f(w(e)),"Could not upload encrypted contacts list"}}async fetch(t,e){try{const s=await this.client.get(`${b}/${t}`,new Headers({"x-doc-hash":e}));return s.status==200?s.json():Promise.resolve(s.status)}catch(s){throw f(w(s)),"Could not fetch encrypted contacts list"}}}let d;function X(r){if(!d){const t=new $(r);d={browserStorage:t,contactsManager:new D(new K),asymmetricCrypto:new R,symmetricCrypto:new J,cryptoCache:new U(t)}}}function _(){return d}function w(r){return r instanceof Error?r:new Error(`${r}`)}function tt(r,t){return{title:r,message:t,type:"show-warning-notification"}}function et(r,t){return{title:r,message:t,type:"show-error-notification"}}const M=r=>S(r,"show-info-notification"),T=r=>S(r,"show-warning-notification");function h(r){return{type:"notification-update",value:r}}class rt extends O{constructor(){super(h([])),super.on(async(t,e)=>{const s={title:t.title,message:t.message,type:L(t)};e(h([s,...this.state.value])),setTimeout(()=>e(h([...this.state.value.filter(n=>n!=s)])),3500)},t=>t!==void 0)}}function L(r){return M(r)?"info":T(r)?"warning":"error"}export{a as A,Q as E,rt as N,O as R,et as S,q as a,H as b,tt as c,f as d,j as e,c as f,w as g,S as i,z as l,Z as p,X as r,_ as w};
